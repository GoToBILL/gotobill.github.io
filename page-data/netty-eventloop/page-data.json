{"componentChunkName":"component---src-templates-blog-post-js","path":"/netty-eventloop/","result":{"data":{"site":{"siteMetadata":{"title":"GoToBill"}},"markdownRemark":{"id":"5a7d2201-d668-5e1b-842e-6da7a5f55fd3","excerpt":"Netty 완전 정복 가이드 Selector 기초부터 OS 레벨 동작, 순수 Java NIO vs Netty 구현, WebClient까지 모든 것을 다룹니다. 목차 Selector란 무엇인가 OS 레벨 I/O 멀티플렉싱 순수 Java NIO 구현 Netty NioEventLoop…","html":"<h1>Netty 완전 정복 가이드</h1>\n<p>Selector 기초부터 OS 레벨 동작, 순수 Java NIO vs Netty 구현, WebClient까지 모든 것을 다룹니다.</p>\n<h2>목차</h2>\n<ol>\n<li><a href=\"#selector%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80\">Selector란 무엇인가</a></li>\n<li><a href=\"#os-%EB%A0%88%EB%B2%A8-io-%EB%A9%80%ED%8B%B0%ED%94%8C%EB%A0%89%EC%8B%B1\">OS 레벨 I/O 멀티플렉싱</a></li>\n<li><a href=\"#%EC%88%9C%EC%88%98-java-nio-%EA%B5%AC%ED%98%84\">순수 Java NIO 구현</a></li>\n<li><a href=\"#netty-nioeventloop-%EA%B5%AC%ED%98%84\">Netty NioEventLoop 구현</a></li>\n<li><a href=\"#%EC%BD%94%EB%93%9C-%EB%B9%84%EA%B5%90-%EB%B6%84%EC%84%9D\">코드 비교 분석</a></li>\n<li><a href=\"#webclient%EC%97%90%EC%84%9C-netty%EA%B9%8C%EC%A7%80\">WebClient에서 Netty까지</a></li>\n<li><a href=\"#%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B8%B0%EB%B2%95\">성능 최적화 기법</a></li>\n</ol>\n<hr>\n<h2>Selector란 무엇인가</h2>\n<h3>개념</h3>\n<p><strong>Selector</strong>는 단일 스레드로 여러 채널의 I/O 이벤트를 모니터링하는 Java NIO의 핵심 컴포넌트입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">전통적인 블로킹 I/O (BIO)\nThread 1 → Socket 1 (blocking read...)\nThread 2 → Socket 2 (blocking read...)\nThread 3 → Socket 3 (blocking read...)\n...\nThread 1000 → Socket 1000 (blocking read...)\n\n문제: 1000개 연결 = 1000개 스레드 = 메모리 부족</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Selector 기반 논블로킹 I/O (NIO)\n        Selector (1개 스레드)\n            ↓\n    ┌───────┼───────┐\nChannel 1 Channel 2 Channel 3 ... Channel 1000\n(wait)    (ready!)   (wait)         (wait)\n\n해결: 1000개 연결 = 1개 스레드 = 메모리 효율적</code></pre></div>\n<h3>Selector의 역할</h3>\n<ol>\n<li><strong>채널 등록</strong>: 여러 채널을 Selector에 등록</li>\n<li><strong>이벤트 감시</strong>: 등록된 채널의 I/O 이벤트 모니터링</li>\n<li><strong>준비된 채널 선택</strong>: I/O 가능한 채널만 선택</li>\n<li><strong>이벤트 처리</strong>: 선택된 채널에 대해 I/O 작업 수행</li>\n</ol>\n<h3>SelectionKey의 이벤트 타입</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_ACCEPT</span>   <span class=\"token comment\">// 서버가 클라이언트 연결 수락 가능</span>\n<span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_CONNECT</span>  <span class=\"token comment\">// 클라이언트가 서버 연결 완료</span>\n<span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span>     <span class=\"token comment\">// 채널에서 데이터 읽기 가능</span>\n<span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_WRITE</span>    <span class=\"token comment\">// 채널에 데이터 쓰기 가능</span></code></pre></div>\n<hr>\n<h2>OS 레벨 I/O 멀티플렉싱</h2>\n<h3>System Call의 진화</h3>\n<h4>1단계: select() (초기)</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Linux select() system call</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> nfds<span class=\"token punctuation\">,</span>\n           fd_set <span class=\"token operator\">*</span>readfds<span class=\"token punctuation\">,</span>    <span class=\"token comment\">// 읽기 가능한 파일 디스크립터</span>\n           fd_set <span class=\"token operator\">*</span>writefds<span class=\"token punctuation\">,</span>   <span class=\"token comment\">// 쓰기 가능한 파일 디스크립터</span>\n           fd_set <span class=\"token operator\">*</span>exceptfds<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 예외 발생한 파일 디스크립터</span>\n           <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timeval</span> <span class=\"token operator\">*</span>timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>문제점</strong>:</p>\n<ul>\n<li>fd_set 크기 제한 (일반적으로 1024개)</li>\n<li>매번 전체 fd_set을 커널로 복사 (O(n))</li>\n<li>준비된 fd를 찾기 위해 전체 순회 필요</li>\n</ul>\n<h4>2단계: poll() (개선)</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Linux poll() system call</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">pollfd</span> <span class=\"token operator\">*</span>fds<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 파일 디스크립터 배열</span>\n         <span class=\"token class-name\">nfds_t</span> nfds<span class=\"token punctuation\">,</span>          <span class=\"token comment\">// 배열 크기</span>\n         <span class=\"token keyword\">int</span> timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">pollfd</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// 파일 디스크립터</span>\n    <span class=\"token keyword\">short</span> events<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 관심 이벤트</span>\n    <span class=\"token keyword\">short</span> revents<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 실제 발생한 이벤트</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>개선점</strong>:</p>\n<ul>\n<li>fd 개수 제한 없음</li>\n<li>비트마스크 대신 구조체 배열 사용</li>\n</ul>\n<p><strong>여전한 문제</strong>:</p>\n<ul>\n<li>매번 전체 배열을 커널로 복사 (O(n))</li>\n<li>준비된 fd를 찾기 위해 전체 순회</li>\n</ul>\n<h4>3단계: epoll() (Linux 최적화)</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// epoll 생성</span>\n<span class=\"token keyword\">int</span> epfd <span class=\"token operator\">=</span> <span class=\"token function\">epoll_create1</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// fd 등록 (한 번만!)</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">epoll_event</span> event<span class=\"token punctuation\">;</span>\nevent<span class=\"token punctuation\">.</span>events <span class=\"token operator\">=</span> EPOLLIN<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 읽기 이벤트</span>\nevent<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>fd <span class=\"token operator\">=</span> sockfd<span class=\"token punctuation\">;</span>\n<span class=\"token function\">epoll_ctl</span><span class=\"token punctuation\">(</span>epfd<span class=\"token punctuation\">,</span> EPOLL_CTL_ADD<span class=\"token punctuation\">,</span> sockfd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 이벤트 대기</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">epoll_event</span> events<span class=\"token punctuation\">[</span>MAX_EVENTS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> nfds <span class=\"token operator\">=</span> <span class=\"token function\">epoll_wait</span><span class=\"token punctuation\">(</span>epfd<span class=\"token punctuation\">,</span> events<span class=\"token punctuation\">,</span> MAX_EVENTS<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 준비된 fd만 반환됨! (O(1) 조회)</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> nfds<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>events<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>events <span class=\"token operator\">&amp;</span> EPOLLIN<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 읽기 가능한 소켓 처리</span>\n        <span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> events<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>fd<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">read</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>핵심 개선</strong>:</p>\n<ul>\n<li>fd를 커널에 한 번만 등록</li>\n<li>준비된 fd만 반환 (O(1) 조회)</li>\n<li>Red-Black Tree로 fd 관리</li>\n<li>Ready List에 준비된 fd만 추가</li>\n</ul>\n<h4>4단계: kqueue() (BSD/macOS)</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// kqueue 생성</span>\n<span class=\"token keyword\">int</span> kq <span class=\"token operator\">=</span> <span class=\"token function\">kqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 이벤트 등록</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">kevent</span> change<span class=\"token punctuation\">;</span>\n<span class=\"token function\">EV_SET</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>change<span class=\"token punctuation\">,</span> sockfd<span class=\"token punctuation\">,</span> EVFILT_READ<span class=\"token punctuation\">,</span> EV_ADD<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">kevent</span><span class=\"token punctuation\">(</span>kq<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>change<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 이벤트 대기</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">kevent</span> event<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> nev <span class=\"token operator\">=</span> <span class=\"token function\">kevent</span><span class=\"token punctuation\">(</span>kq<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>event<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nev <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> event<span class=\"token punctuation\">.</span>filter <span class=\"token operator\">==</span> EVFILT_READ<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 읽기 가능</span>\n    <span class=\"token function\">read</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>ident<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Java NIO와 OS의 연결</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Java Selector.select()\n        ↓\nJNI (Java Native Interface)\n        ↓\n┌───────────────────────────────┐\n│   Linux    │   macOS   │ Windows │\n│   epoll()  │  kqueue() │  IOCP   │\n└───────────────────────────────┘\n        ↓\n커널이 파일 디스크립터 모니터링\n        ↓\n네트워크 카드에서 패킷 도착\n        ↓\n커널 인터럽트 발생\n        ↓\nReady List에 fd 추가\n        ↓\nepoll_wait() 반환\n        ↓\nJava Selector.select() 반환</code></pre></div>\n<h3>OS별 구현 차이</h3>\n<table>\n<thead>\n<tr>\n<th>OS</th>\n<th>System Call</th>\n<th>특징</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Linux</td>\n<td>epoll</td>\n<td>Red-Black Tree, O(1) 조회</td>\n</tr>\n<tr>\n<td>macOS/BSD</td>\n<td>kqueue</td>\n<td>Event-driven, 파일 시스템 감시도 가능</td>\n</tr>\n<tr>\n<td>Windows</td>\n<td>IOCP</td>\n<td>Completion 기반, 비동기 I/O</td>\n</tr>\n<tr>\n<td>Solaris</td>\n<td>/dev/poll</td>\n<td>poll 최적화 버전</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2>순수 Java NIO 구현</h2>\n<h3>전체 코드</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">IOException</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InetSocketAddress</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteBuffer</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SelectionKey</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Selector</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ServerSocketChannel</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SocketChannel</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Iterator</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Set</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NioEchoServer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">7381</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">BUFFER_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 1. Selector 생성 - OS의 epoll/kqueue와 연결</span>\n        <span class=\"token class-name\">Selector</span> selector <span class=\"token operator\">=</span> <span class=\"token class-name\">Selector</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 2. 서버 소켓 생성 및 설정</span>\n        <span class=\"token class-name\">ServerSocketChannel</span> serverSocket <span class=\"token operator\">=</span> <span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 논블로킹 모드!</span>\n\n        <span class=\"token comment\">// 3. Selector에 서버 소켓 등록 (ACCEPT 이벤트 감시)</span>\n        serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_ACCEPT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Echo Server started on port \"</span> <span class=\"token operator\">+</span> <span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ByteBuffer</span> inBuffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token constant\">BUFFER_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ByteBuffer</span> outBuffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token constant\">BUFFER_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 4. 이벤트 루프 - 무한 반복</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 5. I/O 이벤트 대기 (블로킹) - OS epoll_wait() 호출</span>\n            selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// 6. 준비된 채널의 SelectionKey 가져오기</span>\n            <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> selectedKeys <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// 7. 준비된 채널 순회</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                iterator<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 처리 후 제거 (중요!)</span>\n\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// 8-1. ACCEPT 이벤트: 클라이언트 연결</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isAcceptable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token class-name\">ServerSocketChannel</span> server <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token class-name\">SocketChannel</span> client <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 연결 수락</span>\n\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>client <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            client<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token comment\">// 클라이언트를 READ 이벤트로 등록</span>\n                            client<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Client connected: \"</span> <span class=\"token operator\">+</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                    <span class=\"token comment\">// 8-2. READ 이벤트: 데이터 읽기</span>\n                    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isReadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token class-name\">SocketChannel</span> channel <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                        inBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">int</span> readBytes <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>inBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 논블로킹 읽기</span>\n\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readBytes <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token comment\">// 클라이언트 연결 종료</span>\n                            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Client disconnected: \"</span> <span class=\"token operator\">+</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            key<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            channel<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readBytes <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token comment\">// 읽은 데이터를 출력 버퍼로 복사 (Echo)</span>\n                            inBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            outBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            outBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>inBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                            <span class=\"token comment\">// 쓰기 준비</span>\n                            outBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            channel<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>outBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 논블로킹 쓰기</span>\n\n                            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Echoed \"</span> <span class=\"token operator\">+</span> readBytes <span class=\"token operator\">+</span> <span class=\"token string\">\" bytes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error processing key: \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    key<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token comment\">// ignore</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>동작 흐름</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1. Selector.open()\n   ↓\n   JNI → epoll_create1() (Linux)\n   ↓\n   커널에 epoll 인스턴스 생성\n\n2. serverSocket.register(selector, OP_ACCEPT)\n   ↓\n   JNI → epoll_ctl(EPOLL_CTL_ADD, fd, EPOLLIN)\n   ↓\n   커널의 Red-Black Tree에 fd 등록\n\n3. selector.select()\n   ↓\n   JNI → epoll_wait(timeout)\n   ↓\n   커널이 Ready List 확인 (블로킹 대기)\n   ↓\n   패킷 도착 → 인터럽트 → Ready List에 fd 추가\n   ↓\n   epoll_wait() 반환 (준비된 fd 개수)\n   ↓\n   Java로 복귀\n\n4. selector.selectedKeys()\n   ↓\n   준비된 SelectionKey 집합 반환\n\n5. key.isAcceptable() / key.isReadable()\n   ↓\n   이벤트 타입 확인 및 처리\n\n6. channel.read(buffer) / channel.write(buffer)\n   ↓\n   JNI → read(fd, buf, len) / write(fd, buf, len)\n   ↓\n   실제 I/O 수행 (논블로킹)</code></pre></div>\n<hr>\n<h2>Netty NioEventLoop 구현</h2>\n<h3>1. Selector 생성</h3>\n<p><strong>순수 Java NIO</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Selector</span> selector <span class=\"token operator\">=</span> <span class=\"token class-name\">Selector</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>Netty NioEventLoop</strong> (라인 169~230)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">SelectorTuple</span> <span class=\"token function\">openSelector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Selector</span> unwrappedSelector<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// OS의 epoll/kqueue와 연결</span>\n        unwrappedSelector <span class=\"token operator\">=</span> provider<span class=\"token punctuation\">.</span><span class=\"token function\">openSelector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChannelException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed to open a new selector\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">DISABLE_KEY_SET_OPTIMIZATION</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SelectorTuple</span><span class=\"token punctuation\">(</span>unwrappedSelector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Netty 최적화: selectedKeys를 Array로 교체</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">SelectedSelectionKeySet</span> selectedKeySet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SelectedSelectionKeySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Reflection으로 Selector 내부 필드 교체</span>\n    <span class=\"token class-name\">Object</span> maybeException <span class=\"token operator\">=</span> <span class=\"token class-name\">AccessController</span><span class=\"token punctuation\">.</span><span class=\"token function\">doPrivileged</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PrivilegedAction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Field</span> selectedKeysField <span class=\"token operator\">=</span> selectorImplClass<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"selectedKeys\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">Field</span> publicSelectedKeysField <span class=\"token operator\">=</span> selectorImplClass<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"publicSelectedKeys\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token comment\">// Set → Array로 교체 (순회 성능 향상!)</span>\n                selectedKeysField<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>unwrappedSelector<span class=\"token punctuation\">,</span> selectedKeySet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                publicSelectedKeysField<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>unwrappedSelector<span class=\"token punctuation\">,</span> selectedKeySet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    selectedKeys <span class=\"token operator\">=</span> selectedKeySet<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SelectorTuple</span><span class=\"token punctuation\">(</span>unwrappedSelector<span class=\"token punctuation\">,</span>\n                             <span class=\"token keyword\">new</span> <span class=\"token class-name\">SelectedSelectionKeySetSelector</span><span class=\"token punctuation\">(</span>unwrappedSelector<span class=\"token punctuation\">,</span> selectedKeySet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty 최적화 포인트</strong>:</p>\n<ul>\n<li>Selector 내부의 <code class=\"language-text\">Set&lt;SelectionKey></code>를 배열로 교체</li>\n<li>Set 순회보다 배열 순회가 빠름 (캐시 친화적)</li>\n</ul>\n<h3>2. 채널 등록</h3>\n<p><strong>순수 Java NIO</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_ACCEPT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>Netty NioEventLoop</strong> (라인 302~340)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">SelectableChannel</span> ch<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> interestOps<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">NioTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">ObjectUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>interestOps <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"interestOps must be non-zero.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isShutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"event loop shut down\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// EventLoop 스레드에서 실행 중인지 확인</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">inEventLoop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 같은 스레드면 즉시 실행</span>\n        <span class=\"token function\">register0</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">,</span> interestOps<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 다른 스레드면 EventLoop에 제출</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token annotation punctuation\">@Override</span>\n                <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">register0</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">,</span> interestOps<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> ignore<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">register0</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectableChannel</span> ch<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> interestOps<span class=\"token punctuation\">,</span> <span class=\"token class-name\">NioTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 실제 등록 - OS epoll_ctl() 호출</span>\n        ch<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>unwrappedSelector<span class=\"token punctuation\">,</span> interestOps<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EventLoopException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed to register a channel\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty 최적화 포인트</strong>:</p>\n<ul>\n<li>스레드 안전성 보장 (다른 스레드에서 등록 가능)</li>\n<li>EventLoop 스레드에서만 실제 등록 수행</li>\n</ul>\n<h3>3. 이벤트 루프 - run()</h3>\n<p><strong>순수 Java NIO</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> selectedKeys <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 처리...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty NioEventLoop</strong> (라인 441~555)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> selectCnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">// 무한 루프</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> strategy<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// 전략 계산: SELECT, CONTINUE, BUSY_WAIT</span>\n                strategy <span class=\"token operator\">=</span> selectStrategy<span class=\"token punctuation\">.</span><span class=\"token function\">calculateStrategy</span><span class=\"token punctuation\">(</span>selectNowSupplier<span class=\"token punctuation\">,</span> <span class=\"token function\">hasTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>strategy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">case</span> <span class=\"token class-name\">SelectStrategy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CONTINUE</span><span class=\"token operator\">:</span>\n                        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\n                    <span class=\"token keyword\">case</span> <span class=\"token class-name\">SelectStrategy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BUSY_WAIT</span><span class=\"token operator\">:</span>\n                        <span class=\"token comment\">// NIO는 busy-wait 미지원, SELECT로 fall-through</span>\n\n                    <span class=\"token keyword\">case</span> <span class=\"token class-name\">SelectStrategy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SELECT</span><span class=\"token operator\">:</span>\n                        <span class=\"token comment\">// 다음 예약된 작업의 데드라인 계산</span>\n                        <span class=\"token keyword\">long</span> curDeadlineNanos <span class=\"token operator\">=</span> <span class=\"token function\">nextScheduledTaskDeadlineNanos</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>curDeadlineNanos <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            curDeadlineNanos <span class=\"token operator\">=</span> <span class=\"token constant\">NONE</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        nextWakeupNanos<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>curDeadlineNanos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">hasTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                                <span class=\"token comment\">// Task 없으면 I/O 대기</span>\n                                strategy <span class=\"token operator\">=</span> <span class=\"token function\">select</span><span class=\"token punctuation\">(</span>curDeadlineNanos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                            nextWakeupNanos<span class=\"token punctuation\">.</span><span class=\"token function\">lazySet</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AWAKE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        <span class=\"token comment\">// fall through</span>\n                    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// Selector 문제 발생 시 재구성</span>\n                <span class=\"token function\">rebuildSelector0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                selectCnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">handleLoopException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            selectCnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            cancelledKeys <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            needsToSelectAgain <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// I/O 작업과 일반 Task의 비율 설정 (기본 50:50)</span>\n            <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> ioRatio <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ioRatio<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">boolean</span> ranTasks<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ioRatio <span class=\"token operator\">==</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// I/O 100%: I/O 먼저, Task는 남은 시간 전부</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">processSelectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// I/O 이벤트 처리</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                    ranTasks <span class=\"token operator\">=</span> <span class=\"token function\">runAllTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 모든 Task 처리</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// I/O와 Task 비율 조절</span>\n                <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> ioStartTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">nanoTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">processSelectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// I/O 처리</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> ioTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">nanoTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> ioStartTime<span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\">// I/O 시간에 비례해서 Task 시간 계산</span>\n                    ranTasks <span class=\"token operator\">=</span> <span class=\"token function\">runAllTasks</span><span class=\"token punctuation\">(</span>ioTime <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span> <span class=\"token operator\">-</span> ioRatio<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> ioRatio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// I/O 없음: 최소한의 Task만 처리</span>\n                ranTasks <span class=\"token operator\">=</span> <span class=\"token function\">runAllTasks</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ranTasks <span class=\"token operator\">||</span> strategy <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selectCnt <span class=\"token operator\">></span> <span class=\"token constant\">MIN_PREMATURE_SELECTOR_RETURNS</span> <span class=\"token operator\">&amp;&amp;</span> logger<span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Selector.select() returned prematurely {} times in a row\"</span><span class=\"token punctuation\">,</span>\n                            selectCnt <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                selectCnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">unexpectedSelectorWakeup</span><span class=\"token punctuation\">(</span>selectCnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// 예기치 않은 wakeup (JDK epoll bug 대응)</span>\n                selectCnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CancelledKeyException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 무해한 예외, 로그만</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CancelledKeyException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSimpleName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" raised\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">handleLoopException</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 종료 처리</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isShuttingDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">closeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">confirmShutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">handleLoopException</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty 최적화 포인트</strong>:</p>\n<ol>\n<li><strong>ioRatio</strong>: I/O 작업과 일반 Task의 CPU 시간 비율 조절</li>\n<li><strong>JDK epoll bug 대응</strong>: 예기치 않은 wakeup 감지 및 Selector 재구성</li>\n<li><strong>예약된 작업 고려</strong>: 타임아웃을 다음 예약 작업에 맞춤</li>\n</ol>\n<h3>4. selector.select() 호출</h3>\n<p><strong>순수 Java NIO</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 무한 대기</span>\n<span class=\"token comment\">// 또는</span>\nselector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 타임아웃 대기</span></code></pre></div>\n<p><strong>Netty NioEventLoop</strong> (라인 885~893)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> <span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> deadlineNanos<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>deadlineNanos <span class=\"token operator\">==</span> <span class=\"token constant\">NONE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 예약된 작업 없음: 무한 대기</span>\n        <span class=\"token keyword\">return</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// OS epoll_wait(-1)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 데드라인까지 남은 시간 계산</span>\n    <span class=\"token keyword\">long</span> timeoutMillis <span class=\"token operator\">=</span> <span class=\"token function\">deadlineToDelayNanos</span><span class=\"token punctuation\">(</span>deadlineNanos <span class=\"token operator\">+</span> <span class=\"token number\">995000L</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000000L</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 타임아웃이 0 이하면 논블로킹 select</span>\n    <span class=\"token keyword\">return</span> timeoutMillis <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>timeoutMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//                          ↑ 즉시 반환           ↑ 타임아웃 대기</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>호출 흐름</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">selector.select(timeoutMillis)\n    ↓\nJNI\n    ↓\nLinux: epoll_wait(epfd, events, maxevents, timeout)\nmacOS: kevent(kq, NULL, 0, events, nevents, timeout)\n    ↓\n커널이 Ready List 확인\n    ↓\n패킷 도착 or 타임아웃\n    ↓\n반환 (준비된 fd 개수)</code></pre></div>\n<h3>5. selectedKeys 처리</h3>\n<p><strong>순수 Java NIO</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> selectedKeys <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    iterator<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 처리...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty NioEventLoop - 최적화된 버전</strong> (라인 719~753)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">processSelectedKeysOptimized</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// selectedKeys는 배열로 교체됨 (openSelector에서)</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> selectedKeys<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">SelectionKey</span> k <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// GC를 위해 null 처리</span>\n        selectedKeys<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> a <span class=\"token operator\">=</span> k<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>a <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AbstractNioChannel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">processSelectedKey</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AbstractNioChannel</span><span class=\"token punctuation\">)</span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">NioTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectableChannel</span><span class=\"token punctuation\">></span></span> task <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NioTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectableChannel</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> a<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">processSelectedKey</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needsToSelectAgain<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 배열 초기화</span>\n            selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">reset</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">selectAgain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            i <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty NioEventLoop - 일반 버전</strong> (라인 673~711)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">processSelectedKeysPlain</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> selectedKeys<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> i <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">SelectionKey</span> k <span class=\"token operator\">=</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> a <span class=\"token operator\">=</span> k<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        i<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Iterator에서 제거</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>a <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AbstractNioChannel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">processSelectedKey</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AbstractNioChannel</span><span class=\"token punctuation\">)</span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">NioTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectableChannel</span><span class=\"token punctuation\">></span></span> task <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NioTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectableChannel</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> a<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">processSelectedKey</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>i<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needsToSelectAgain<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">selectAgain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            selectedKeys <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// ConcurrentModificationException 방지</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                i <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>최적화 포인트</strong>:</p>\n<ul>\n<li>Set Iterator 대신 배열 인덱스 사용</li>\n<li>Iterator 생성 오버헤드 제거</li>\n<li>캐시 친화적인 순차 접근</li>\n</ul>\n<h3>6. 개별 이벤트 처리</h3>\n<p><strong>순수 Java NIO</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isAcceptable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">ServerSocketChannel</span> server <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">SocketChannel</span> client <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    client<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    client<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isReadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SocketChannel</span> channel <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> readBytes <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>inBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readBytes <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        channel<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Echo</span>\n        inBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        channel<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>inBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty NioEventLoop</strong> (라인 768~821)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">processSelectedKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span> k<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AbstractNioChannel</span> ch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">AbstractNioChannel<span class=\"token punctuation\">.</span>NioUnsafe</span> unsafe <span class=\"token operator\">=</span> ch<span class=\"token punctuation\">.</span><span class=\"token function\">unsafe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// SelectionKey 유효성 검사</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>k<span class=\"token punctuation\">.</span><span class=\"token function\">isValid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">EventLoop</span> eventLoop<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            eventLoop <span class=\"token operator\">=</span> ch<span class=\"token punctuation\">.</span><span class=\"token function\">eventLoop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> ignored<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 이 EventLoop에 등록된 채널인지 확인</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>eventLoop <span class=\"token operator\">==</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">voidPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> readyOps <span class=\"token operator\">=</span> k<span class=\"token punctuation\">.</span><span class=\"token function\">readyOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// OP_CONNECT: 연결 완료</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>readyOps <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_CONNECT</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// OP_CONNECT 제거 (무한 루프 방지)</span>\n            <span class=\"token keyword\">int</span> ops <span class=\"token operator\">=</span> k<span class=\"token punctuation\">.</span><span class=\"token function\">interestOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            ops <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_CONNECT</span><span class=\"token punctuation\">;</span>\n            k<span class=\"token punctuation\">.</span><span class=\"token function\">interestOps</span><span class=\"token punctuation\">(</span>ops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">finishConnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// OP_WRITE: 쓰기 가능</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>readyOps <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_WRITE</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 버퍼에 남은 데이터 flush</span>\n            unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">forceFlush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// OP_READ or OP_ACCEPT: 읽기/연결 수락</span>\n        <span class=\"token comment\">// readyOps == 0 체크는 JDK bug workaround</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>readyOps <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_ACCEPT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> readyOps <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CancelledKeyException</span> ignored<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">voidPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Netty의 Unsafe 클래스</strong>:</p>\n<ul>\n<li>실제 I/O 작업을 수행하는 내부 클래스</li>\n<li>채널 타입별로 구현 (NioServerSocketChannel, NioSocketChannel 등)</li>\n<li>사용자는 직접 호출 불가 (internal API)</li>\n</ul>\n<hr>\n<h2>코드 비교 분석</h2>\n<h3>1. Selector 생성</h3>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th>순수 Java NIO</th>\n<th>Netty</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>생성</td>\n<td><code class=\"language-text\">Selector.open()</code></td>\n<td><code class=\"language-text\">provider.openSelector()</code> + 최적화</td>\n</tr>\n<tr>\n<td>최적화</td>\n<td>없음</td>\n<td>selectedKeys를 Set → Array로 교체</td>\n</tr>\n<tr>\n<td>코드</td>\n<td>1줄</td>\n<td>~60줄 (Reflection 포함)</td>\n</tr>\n</tbody>\n</table>\n<h3>2. 이벤트 루프 구조</h3>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th>순수 Java NIO</th>\n<th>Netty</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>루프</td>\n<td><code class=\"language-text\">while(true)</code></td>\n<td><code class=\"language-text\">for(;;)</code> + 종료 처리</td>\n</tr>\n<tr>\n<td>select()</td>\n<td>매번 호출</td>\n<td>전략 패턴 (Task 있으면 skip)</td>\n</tr>\n<tr>\n<td>Task 처리</td>\n<td>없음</td>\n<td>I/O와 Task 비율 조절 (ioRatio)</td>\n</tr>\n<tr>\n<td>예외 처리</td>\n<td>기본 try-catch</td>\n<td>epoll bug 감지 및 재구성</td>\n</tr>\n</tbody>\n</table>\n<h3>3. selectedKeys 순회</h3>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th>순수 Java NIO</th>\n<th>Netty (최적화)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>자료구조</td>\n<td><code class=\"language-text\">Set&lt;SelectionKey></code></td>\n<td><code class=\"language-text\">SelectionKey[]</code></td>\n</tr>\n<tr>\n<td>순회</td>\n<td>Iterator</td>\n<td>배열 인덱스</td>\n</tr>\n<tr>\n<td>성능</td>\n<td>Iterator 생성 오버헤드</td>\n<td>캐시 친화적 순차 접근</td>\n</tr>\n</tbody>\n</table>\n<p><strong>성능 차이</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Set Iterator 순회: ~100ns per iteration\nArray 인덱스 순회: ~10ns per iteration\n\n10배 빠름!</code></pre></div>\n<h3>4. 이벤트 처리</h3>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th>순수 Java NIO</th>\n<th>Netty</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>처리 방식</td>\n<td>직접 I/O 호출</td>\n<td>Unsafe 클래스 위임</td>\n</tr>\n<tr>\n<td>에러 처리</td>\n<td>간단한 예외 처리</td>\n<td>세밀한 상태 관리</td>\n</tr>\n<tr>\n<td>확장성</td>\n<td>하드코딩</td>\n<td>채널 타입별 다형성</td>\n</tr>\n</tbody>\n</table>\n<h3>5. 스레드 모델</h3>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th>순수 Java NIO</th>\n<th>Netty</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>스레드 개수</td>\n<td>1개 (단일 스레드)</td>\n<td>N개 (EventLoopGroup)</td>\n</tr>\n<tr>\n<td>스레드 안전성</td>\n<td>보장 안 됨</td>\n<td>inEventLoop() 체크</td>\n</tr>\n<tr>\n<td>작업 제출</td>\n<td>지원 안 됨</td>\n<td>execute(Runnable)</td>\n</tr>\n</tbody>\n</table>\n<h3>전체 비교표</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌─────────────────────────────────────────────────────────────┐\n│                    순수 Java NIO                             │\n├─────────────────────────────────────────────────────────────┤\n│ while (true) {                                              │\n│     selector.select();              // OS epoll_wait()      │\n│     Set&lt;SelectionKey> keys =                                │\n│         selector.selectedKeys();                            │\n│     Iterator&lt;SelectionKey> it =                             │\n│         keys.iterator();                                    │\n│     while (it.hasNext()) {                                  │\n│         SelectionKey key = it.next();                       │\n│         it.remove();                                        │\n│         if (key.isReadable()) {                             │\n│             SocketChannel ch =                              │\n│                 (SocketChannel) key.channel();              │\n│             ch.read(buffer);        // 직접 I/O            │\n│         }                                                   │\n│     }                                                       │\n│ }                                                           │\n└─────────────────────────────────────────────────────────────┘\n\n                            VS\n\n┌─────────────────────────────────────────────────────────────┐\n│                      Netty NioEventLoop                      │\n├─────────────────────────────────────────────────────────────┤\n│ for (;;) {                                                  │\n│     // 전략 계산: Task 있으면 select skip                   │\n│     strategy = selectStrategy.calculate();                  │\n│                                                             │\n│     if (strategy == SELECT) {                               │\n│         // 다음 예약 작업 고려한 타임아웃                    │\n│         strategy = select(nextDeadline);                    │\n│     }                                                       │\n│                                                             │\n│     // I/O 처리 (최적화된 배열 순회)                        │\n│     if (strategy > 0) {                                     │\n│         processSelectedKeys();      // 배열 인덱스 순회     │\n│     }                                                       │\n│                                                             │\n│     // Task 처리 (I/O와 비율 조절)                          │\n│     runAllTasks(ioTime * ratio);                            │\n│                                                             │\n│     // epoll bug 감지 및 재구성                             │\n│     if (unexpectedWakeup()) {                               │\n│         rebuildSelector();                                  │\n│     }                                                       │\n│ }                                                           │\n└─────────────────────────────────────────────────────────────┘</code></pre></div>\n<hr>\n<h2>WebClient에서 Netty까지</h2>\n<h3>전체 호출 스택</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌─────────────────────────────────────────────────────────┐\n│          Application Layer (당신의 코드)                  │\n├─────────────────────────────────────────────────────────┤\n│ WebClient.post()                                        │\n│     .uri(\"/api\")                                        │\n│     .bodyValue(requestBody)                             │\n│     .retrieve()                                         │\n│     .bodyToMono(Map.class)                              │\n│     .subscribe(...)                                     │\n└─────────────────────────────────────────────────────────┘\n                    ↓\n┌─────────────────────────────────────────────────────────┐\n│       Spring WebFlux Layer (DefaultWebClient)           │\n├─────────────────────────────────────────────────────────┤\n│ DefaultWebClient.exchange()                             │\n│   → ExchangeFunction.exchange(request)                  │\n│   → ReactorClientHttpConnector.connect()                │\n└─────────────────────────────────────────────────────────┘\n                    ↓\n┌─────────────────────────────────────────────────────────┐\n│    Reactor Netty Layer (HttpClient)                     │\n├─────────────────────────────────────────────────────────┤\n│ HttpClient.request(POST)                                │\n│     .uri(\"https://api.example.com\")                     │\n│     .send((request, outbound) -> ...)                   │\n│     .responseConnection((response, connection) -> ...)  │\n└─────────────────────────────────────────────────────────┘\n                    ↓\n┌─────────────────────────────────────────────────────────┐\n│       Netty Core Layer (NioEventLoop)                   │\n├─────────────────────────────────────────────────────────┤\n│ NioEventLoop.run()                                      │\n│   for (;;) {                                            │\n│       selector.select()      // I/O 이벤트 대기         │\n│       processSelectedKeys()  // 이벤트 처리             │\n│       runAllTasks()          // Task 처리               │\n│   }                                                     │\n└─────────────────────────────────────────────────────────┘\n                    ↓\n┌─────────────────────────────────────────────────────────┐\n│          JNI Layer (Native Code)                        │\n├─────────────────────────────────────────────────────────┤\n│ EPollArrayWrapper.poll()     // Linux                   │\n│ KQueueArrayWrapper.poll()    // macOS                   │\n└─────────────────────────────────────────────────────────┘\n                    ↓\n┌─────────────────────────────────────────────────────────┐\n│           OS Kernel Layer                               │\n├─────────────────────────────────────────────────────────┤\n│ epoll_wait(epfd, events, maxevents, timeout)  // Linux  │\n│ kevent(kq, NULL, 0, events, nevents, timeout) // macOS  │\n│                                                         │\n│ [Ready List 모니터링]                                   │\n│   fd 1: 대기 중                                         │\n│   fd 2: READ 준비 완료! ← 패킷 도착                     │\n│   fd 3: 대기 중                                         │\n└─────────────────────────────────────────────────────────┘\n                    ↓\n┌─────────────────────────────────────────────────────────┐\n│         Network Hardware Layer                          │\n├─────────────────────────────────────────────────────────┤\n│ 네트워크 카드에서 패킷 수신                              │\n│   ↓                                                     │\n│ 인터럽트 발생                                           │\n│   ↓                                                     │\n│ 커널이 Ready List에 fd 추가                             │\n│   ↓                                                     │\n│ epoll_wait() 반환                                       │\n└─────────────────────────────────────────────────────────┘</code></pre></div>\n<h3>상세 실행 흐름</h3>\n<h4>1. WebClient 요청 시작</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 당신의 코드 (http-nio-8080-exec-5 스레드)</span>\n<span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> response <span class=\"token operator\">=</span> webClient<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">bodyValue</span><span class=\"token punctuation\">(</span>requestBody<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">retrieve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">bodyToMono</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nresponse<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 이 부분은 reactor-http-nio-2에서 실행</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>2. Spring WebFlux Layer</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// DefaultWebClient.java</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ClientResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">exchange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Mono</span><span class=\"token punctuation\">.</span><span class=\"token function\">defer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// HTTP 요청 생성</span>\n        <span class=\"token class-name\">ClientHttpRequest</span> httpRequest <span class=\"token operator\">=</span> <span class=\"token function\">createRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// ReactorClientHttpConnector로 전달</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connector<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>uri<span class=\"token punctuation\">,</span>\n            requestCallback\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>3. Reactor Netty Layer</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// ReactorClientHttpConnector.java</span>\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ClientHttpResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpMethod</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">URI</span> uri<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>httpClient\n        <span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token function\">adaptHttpMethod</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">uri</span><span class=\"token punctuation\">(</span>uri<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> outbound<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 요청 본문 전송</span>\n            <span class=\"token keyword\">return</span> requestCallback<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ReactorClientHttpRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">responseConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span> connection<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 응답 수신</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">Mono</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ReactorClientHttpResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>4. Netty Core - Channel 등록</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// Bootstrap.java</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ChannelFuture</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketAddress</span> remoteAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">ChannelFuture</span> regFuture <span class=\"token operator\">=</span> <span class=\"token function\">initAndRegister</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Channel을 EventLoop에 등록</span>\n    <span class=\"token class-name\">Channel</span> channel <span class=\"token operator\">=</span> regFuture<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">EventLoop</span> eventLoop <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">eventLoop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// EventLoop에서 실행</span>\n    eventLoop<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        channel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_CONNECT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        channel<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>remoteAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> regFuture<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>5. Netty Core - EventLoop 동작</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// NioEventLoop.run() - reactor-http-nio-2 스레드</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1. I/O 이벤트 대기</span>\n    selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>timeoutMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//   ↓</span>\n    <span class=\"token comment\">// JNI → epoll_wait()</span>\n    <span class=\"token comment\">//   ↓</span>\n    <span class=\"token comment\">// 커널이 Ready List 확인</span>\n    <span class=\"token comment\">//   ↓</span>\n    <span class=\"token comment\">// HTTP 응답 패킷 도착!</span>\n    <span class=\"token comment\">//   ↓</span>\n    <span class=\"token comment\">// fd가 READ 가능 상태가 됨</span>\n    <span class=\"token comment\">//   ↓</span>\n    <span class=\"token comment\">// epoll_wait() 반환</span>\n\n    <span class=\"token comment\">// 2. 준비된 채널 처리</span>\n    <span class=\"token function\">processSelectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//   ↓</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> selectedKeys<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">AbstractNioChannel</span> channel <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AbstractNioChannel</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span>readyOps <span class=\"token operator\">&amp;</span> <span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 3. 데이터 읽기</span>\n            channel<span class=\"token punctuation\">.</span><span class=\"token function\">unsafe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//   ↓</span>\n            <span class=\"token comment\">// ByteBuffer에 데이터 읽기</span>\n            <span class=\"token class-name\">ByteBuffer</span> buffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token number\">8192</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">int</span> bytesRead <span class=\"token operator\">=</span> socketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//   ↓</span>\n            <span class=\"token comment\">// 4. Pipeline 처리</span>\n            <span class=\"token class-name\">ChannelPipeline</span> pipeline <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">pipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            pipeline<span class=\"token punctuation\">.</span><span class=\"token function\">fireChannelRead</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//   ↓</span>\n            <span class=\"token comment\">// HttpClientCodec: HTTP 파싱</span>\n            <span class=\"token comment\">// HttpObjectAggregator: 청크 병합</span>\n            <span class=\"token comment\">// ReactorNettyHandler: Mono/Flux로 변환</span>\n            <span class=\"token comment\">//   ↓</span>\n            <span class=\"token comment\">// 5. Mono에 데이터 전달</span>\n            sink<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>httpResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 6. 일반 Task 처리</span>\n    <span class=\"token function\">runAllTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>6. 데이터가 Mono로 전달</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// reactor-http-nio-2 스레드</span>\nmono\n    <span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 여기서 실행!</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread: {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 출력: Thread: reactor-http-nio-2</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">::</span><span class=\"token function\">parseResponse</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 최종 처리</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h2>성능 최적화 기법</h2>\n<h3>1. Zero-Copy</h3>\n<p><strong>일반적인 데이터 복사</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">네트워크 카드\n    ↓ DMA 복사\n커널 버퍼\n    ↓ CPU 복사 (1)\nJVM 힙\n    ↓ CPU 복사 (2)\n애플리케이션 버퍼\n\n총 4번의 데이터 이동!</code></pre></div>\n<p><strong>Netty의 Zero-Copy</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// Direct Buffer 사용</span>\n<span class=\"token class-name\">ByteBuffer</span> directBuffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocateDirect</span><span class=\"token punctuation\">(</span><span class=\"token number\">8192</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 네트워크 카드</span>\n<span class=\"token comment\">//     ↓ DMA 복사</span>\n<span class=\"token comment\">// 커널 버퍼</span>\n<span class=\"token comment\">//     ↓ DMA 복사 (CPU 개입 없음!)</span>\n<span class=\"token comment\">// Direct Buffer (JVM 힙 외부)</span>\n<span class=\"token comment\">//     ↓</span>\n<span class=\"token comment\">// 애플리케이션 직접 접근</span>\n\n총 <span class=\"token number\">2</span>번의 이동<span class=\"token punctuation\">,</span> <span class=\"token constant\">CPU</span> 사용 최소화<span class=\"token operator\">!</span></code></pre></div>\n<p><strong>Netty CompositeByteBuf</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 여러 버퍼를 복사 없이 결합</span>\n<span class=\"token class-name\">ByteBuf</span> header <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">ByteBuf</span> body <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">CompositeByteBuf</span> composite <span class=\"token operator\">=</span> <span class=\"token class-name\">Unpooled</span><span class=\"token punctuation\">.</span><span class=\"token function\">compositeBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncomposite<span class=\"token punctuation\">.</span><span class=\"token function\">addComponents</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 실제 복사 없음! 논리적 결합만</span></code></pre></div>\n<h3>2. Object Pooling</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// Netty의 PooledByteBufAllocator</span>\n<span class=\"token class-name\">ByteBufAllocator</span> alloc <span class=\"token operator\">=</span> <span class=\"token class-name\">PooledByteBufAllocator</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DEFAULT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 풀에서 재사용</span>\n<span class=\"token class-name\">ByteBuf</span> buffer <span class=\"token operator\">=</span> alloc<span class=\"token punctuation\">.</span><span class=\"token function\">buffer</span><span class=\"token punctuation\">(</span><span class=\"token number\">8192</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    buffer<span class=\"token punctuation\">.</span><span class=\"token function\">writeBytes</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    channel<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 풀로 반환 (GC 없음!)</span>\n    buffer<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>효과</strong>:</p>\n<ul>\n<li>GC 압박 감소</li>\n<li>메모리 할당 오버헤드 제거</li>\n<li>처리량 30-50% 향상</li>\n</ul>\n<h3>3. 배치 처리</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// NioEventLoop - 여러 이벤트를 한 번에 처리</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">processSelectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> selectedKeys<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 배치 처리로 시스템 콜 최소화</span>\n        <span class=\"token function\">processSelectedKey</span><span class=\"token punctuation\">(</span>selectedKeys<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Write 배치 처리</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 여러 write를 모아서 한 번에 전송</span>\n    <span class=\"token class-name\">ByteBuf</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> buffers <span class=\"token operator\">=</span> outboundBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">nioBuffers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> bytesWritten <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>buffers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>4. Backpressure</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// Netty의 자동 Backpressure</span>\nchannel<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAutoRead</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 읽기 중단</span>\n\n<span class=\"token comment\">// 처리 완료 후 재개</span>\nchannel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 읽기 재개</span></code></pre></div>\n<p><strong>Reactor의 Backpressure</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureBuffer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 버퍼링</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureDrop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>         <span class=\"token comment\">// 드랍</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureLatest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>       <span class=\"token comment\">// 최신 값만</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">BaseSubscriber</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">hookOnSubscribe</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Subscription</span> subscription<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 10개만 요청</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">hookOnNext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 처리</span>\n            <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 1개 더 요청</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>5. 스레드 친화성 (Thread Affinity)</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// EventLoopGroup - CPU 코어별 EventLoop</span>\n<span class=\"token class-name\">EventLoopGroup</span> group <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NioEventLoopGroup</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 각 EventLoop는 하나의 Selector를 가짐</span>\n<span class=\"token comment\">// → CPU 캐시 친화적</span></code></pre></div>\n<hr>\n<h2>정리</h2>\n<h3>Java NIO Selector의 핵심</h3>\n<ol>\n<li><strong>단일 스레드로 다중 채널 처리</strong></li>\n<li><strong>OS 커널의 I/O 멀티플렉싱 활용</strong></li>\n<li><strong>논블로킹 I/O로 스레드 블로킹 없음</strong></li>\n</ol>\n<h3>Netty가 Java NIO보다 나은 이유</h3>\n<ol>\n<li>\n<p><strong>성능 최적화</strong></p>\n<ul>\n<li>selectedKeys를 Set → Array로 교체</li>\n<li>Zero-Copy 기술</li>\n<li>Object Pooling</li>\n</ul>\n</li>\n<li>\n<p><strong>안정성</strong></p>\n<ul>\n<li>JDK epoll bug 자동 감지 및 복구</li>\n<li>세밀한 에러 처리</li>\n<li>Backpressure 지원</li>\n</ul>\n</li>\n<li>\n<p><strong>확장성</strong></p>\n<ul>\n<li>EventLoopGroup으로 멀티 스레드</li>\n<li>Channel Pipeline으로 확장 가능</li>\n<li>다양한 프로토콜 지원</li>\n</ul>\n</li>\n<li>\n<p><strong>사용성</strong></p>\n<ul>\n<li>고수준 추상화 (Channel, Pipeline)</li>\n<li>Reactor와 통합</li>\n<li>Spring WebFlux 기본 클라이언트</li>\n</ul>\n</li>\n</ol>\n<h3>WebClient → Netty → OS 전체 흐름</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">WebClient.subscribe()\n    ↓ (메인 스레드)\nMono 체인 구성\n    ↓\nReactorClientHttpConnector\n    ↓\nNetty HttpClient.request()\n    ↓\nChannel.write() → EventLoop에 제출\n    ↓ (reactor-http-nio-2 스레드)\nNioEventLoop.execute(task)\n    ↓\nselector.select() 호출\n    ↓ (JNI)\nepoll_wait() / kevent() 호출\n    ↓ (OS 커널)\nReady List 모니터링\n    ↓\n네트워크 패킷 도착\n    ↓\n인터럽트 발생\n    ↓\nReady List에 fd 추가\n    ↓\nepoll_wait() 반환\n    ↓ (Java)\nprocessSelectedKeys()\n    ↓\nchannel.read() → ByteBuf\n    ↓\nPipeline 처리 (HTTP 파싱)\n    ↓\nMono.next(response)\n    ↓\n.doOnNext() 실행\n    ↓\n.subscribe() 콜백 실행</code></pre></div>\n<h3>핵심 코드 위치</h3>\n<p><strong>Java NIO</strong>:</p>\n<ul>\n<li><code class=\"language-text\">java.nio.channels.Selector</code></li>\n<li><code class=\"language-text\">java.nio.channels.SelectionKey</code></li>\n<li><code class=\"language-text\">java.nio.channels.SocketChannel</code></li>\n</ul>\n<p><strong>Netty</strong>:</p>\n<ul>\n<li><code class=\"language-text\">io.netty.channel.nio.NioEventLoop</code> - EventLoop 구현</li>\n<li><code class=\"language-text\">io.netty.channel.nio.NioSocketChannel</code> - Channel 구현</li>\n<li><code class=\"language-text\">io.netty.buffer.ByteBuf</code> - 버퍼 추상화</li>\n<li><code class=\"language-text\">io.netty.channel.ChannelPipeline</code> - 처리 파이프라인</li>\n</ul>\n<p><strong>Reactor Netty</strong>:</p>\n<ul>\n<li><code class=\"language-text\">reactor.netty.http.client.HttpClient</code></li>\n<li><code class=\"language-text\">reactor.netty.Connection</code></li>\n</ul>\n<p><strong>Spring WebFlux</strong>:</p>\n<ul>\n<li><code class=\"language-text\">org.springframework.web.reactive.function.client.WebClient</code></li>\n<li><code class=\"language-text\">org.springframework.http.client.reactive.ReactorClientHttpConnector</code></li>\n</ul>\n<blockquote>\n<p><strong>Netty 이벤트 루프를 이해하면 WebClient의 비동기 처리를 완전히 이해할 수 있습니다</strong></p>\n<p><br>\n<a href=\"../webclient\">Spring WebClient와 논블로킹 I/O</a>에서 WebClient의 실전 사용법을 확인하세요.</p>\n</blockquote>","wordCount":{"words":732},"frontmatter":{"title":"Netty 이벤트 루프 완전 정복","date":"October 09, 2025","description":"Netty의 이벤트 루프 방식이 어떻게 수천 개의 연결을 소수의 스레드로 처리하는지 깊이 있게 분석합니다"}},"previous":{"fields":{"slug":"/webclient/"},"frontmatter":{"title":"Spring WebClient와 논블로킹 I/O"}},"next":{"fields":{"slug":"/mysql-stats-info/"},"frontmatter":{"title":"MySQL 테이블 통계 정보"}}},"pageContext":{"id":"5a7d2201-d668-5e1b-842e-6da7a5f55fd3","previousPostId":"5e194fa8-ede1-5b2d-8ed6-b59568133763","nextPostId":"4999f5fd-0945-585d-817d-9fc01cd371fa"}},"staticQueryHashes":["3257411868","3517523002"],"slicesMap":{}}