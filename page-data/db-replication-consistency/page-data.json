{"componentChunkName":"component---src-templates-blog-post-js","path":"/db-replication-consistency/","result":{"data":{"site":{"siteMetadata":{"title":"GoToBill"}},"markdownRemark":{"id":"95e30fc0-854e-58ee-8973-9a235ae408e8","excerpt":"들어가며 대규모 서비스에서는 읽기 부하 분산을 위해 Master-Slave(Primary-Replica…","html":"<h2>들어가며</h2>\n<p>대규모 서비스에서는 읽기 부하 분산을 위해 Master-Slave(Primary-Replica) 복제 구조를 사용합니다. 하지만 복제는 즉시 이루어지지 않기 때문에 <strong>데이터 일관성 문제</strong>가 발생할 수 있습니다.</p>\n<p>이 글에서는 복제 지연이 왜 발생하는지, 어떤 문제를 일으키는지, 그리고 어떻게 해결하는지 알아봅니다.</p>\n<h2>Master-Slave 복제 구조</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a5c13a15209167b8c8194ae9bb7fe972/2e367/master-slave-structure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.08860759493672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuklEQVR42pWSjW6bMBSF8/5v1TeotG6l0VbShFECxIAB47/rs2uTJpnWrqoly+jKPnzn3LvBJ0trDaVUOud5hvf+v/c3nwmO44iyLLHf75HneRKOK4TwBcF4+fxgkhJ1XaOqqiSstblc+TJhMAZummCshXMOxlhMi/tQ7F3BKGKyDMv9PXzbXlDeRHbtgsdyQtEtILoqh38Ezy8c2zLbLVxRwL2+pno47/g9G492tDgI/S7p5k0sktEwwDfNRwGsXbcEx2RVr9FKjcV6zNrDeroKBh4FL0Ta1HUgzu3SmAtGAKkagxwRB6c5CXzPtvwDD+0II2d7JSRKedndLlkOPHer0FmMPDuQfDr0yiXLZafwUktUg0EjLZPeErIgzYofzQg8Z9H+Wreg8QDqf3G9R5iPkDyXcZ1Eh+yJs/bR7prtTYY+EdHwm7uiE0kqzzXo9Mj1HduNHScMTHiUBvuTwvNRohALaqZUfxHaCb7P4Q53IJGxUMMRsFD3k8VyJnxmwoFdrITxad0KPPx44vx4PjnDSfvbpmi2VnCHvyV7tIhUi0Rg2/BmpSbDTXBQhiCVZVqTrCqz2o6CfwAaGfjIAx7kxAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"마스터-슬레이브 복제 구조\"\n        title=\"\"\n        src=\"/static/a5c13a15209167b8c8194ae9bb7fe972/f058b/master-slave-structure.png\"\n        srcset=\"/static/a5c13a15209167b8c8194ae9bb7fe972/c26ae/master-slave-structure.png 158w,\n/static/a5c13a15209167b8c8194ae9bb7fe972/6bdcf/master-slave-structure.png 315w,\n/static/a5c13a15209167b8c8194ae9bb7fe972/f058b/master-slave-structure.png 630w,\n/static/a5c13a15209167b8c8194ae9bb7fe972/40601/master-slave-structure.png 945w,\n/static/a5c13a15209167b8c8194ae9bb7fe972/2e367/master-slave-structure.png 1066w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>비동기 복제의 동작 방식</h3>\n<p>MySQL의 기본 복제는 <strong>비동기(Asynchronous)</strong> 방식입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[비동기 복제 흐름]\n1. Client가 Master에 INSERT 실행\n2. Master가 Binlog에 기록\n3. Master가 Client에 즉시 응답 (커밋 완료)\n4. Slave가 Binlog를 가져와서 Relay Log에 저장\n5. Slave가 Relay Log를 실행하여 데이터 반영</code></pre></div>\n<p>3번과 5번 사이에 시간 차이가 발생하는데, 이것이 <strong>Replication Lag</strong>입니다.</p>\n<h2>복제 지연이 일으키는 문제</h2>\n<h3>1. Read-Your-Writes 불일치</h3>\n<p>가장 흔한 문제입니다. 사용자가 데이터를 저장한 직후 조회했는데 반영이 안 된 것처럼 보입니다.</p>\n<!-- [다이어그램 2: Read-Your-Writes 문제]\n시간순으로:\n1. 사용자 -> Master: 닉네임 변경 (user123 -> newName)\n2. Master -> 사용자: 변경 완료!\n3. 사용자 -> Slave: 내 프로필 조회\n4. Slave -> 사용자: 닉네임: user123 (아직 복제 안됨)\n5. 사용자: \"???\"\n-->\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 문제 상황 예시</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateAndShow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> newNickname<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1. Master에 쓰기</span>\n    userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">updateNickname</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> newNickname<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 2. Slave에서 읽기 (복제 지연으로 이전 값이 조회될 수 있음)</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// user.getNickname()이 여전히 이전 값일 수 있음</span>\n    <span class=\"token keyword\">return</span> user<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>실제 사례</strong></p>\n<ul>\n<li>회원가입 직후 로그인 시도 시 \"존재하지 않는 회원\" 오류</li>\n<li>게시글 작성 후 목록에서 안 보임</li>\n<li>결제 완료 후 주문 내역에서 조회 안 됨</li>\n</ul>\n<h3>2. Monotonic Read 불일치</h3>\n<p>같은 데이터를 연속으로 읽었는데 값이 왔다 갔다 하는 현상입니다.</p>\n<!-- [다이어그램 3: Monotonic Read 문제]\nSlave1: 복제 완료 (최신 데이터)\nSlave2: 복제 지연 (이전 데이터)\n\n1번째 조회 -> Slave1 -> 주문상태: 배송중\n2번째 조회 -> Slave2 -> 주문상태: 결제완료 (과거 상태)\n3번째 조회 -> Slave1 -> 주문상태: 배송중\n\n사용자 입장에서 상태가 왔다갔다 하는 것처럼 보임\n-->\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[시나리오]\n사용자의 연속 조회:\n1번째 조회 --> Slave1 --> 주문상태: \"배송중\"\n2번째 조회 --> Slave2 --> 주문상태: \"결제완료\" (?)\n3번째 조회 --> Slave1 --> 주문상태: \"배송중\"\n\nSlave 간 복제 진행도가 달라서 발생</code></pre></div>\n<h3>3. 팬텀 데이터</h3>\n<p>트랜잭션 내에서 여러 테이블을 조회할 때, 일부는 최신 데이터고 일부는 과거 데이터인 상황입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 주문과 결제가 동시에 생성되었는데</span>\n<span class=\"token class-name\">Order</span> order <span class=\"token operator\">=</span> orderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Slave1에서 조회 - 있음</span>\n<span class=\"token class-name\">Payment</span> payment <span class=\"token operator\">=</span> paymentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByOrderId</span><span class=\"token punctuation\">(</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Slave2에서 조회 - 없음</span>\n\n<span class=\"token comment\">// 주문은 있는데 결제 정보가 없는 비정상 상태로 보임</span></code></pre></div>\n<h2>복제 지연 측정</h2>\n<p>문제를 해결하기 전에 현재 지연 상태를 파악해야 합니다.</p>\n<h3>MySQL에서 복제 지연 확인</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- Slave에서 실행</span>\n<span class=\"token keyword\">SHOW</span> SLAVE <span class=\"token keyword\">STATUS</span>\\G\n\n<span class=\"token comment\">-- 주요 확인 항목</span>\nSeconds_Behind_Master: <span class=\"token number\">5</span>  <span class=\"token comment\">-- Master 대비 5초 지연</span>\nSlave_IO_Running: Yes\nSlave_SQL_Running: Yes</code></pre></div>\n<h2>해결 전략</h2>\n<h3>1. Read-Your-Writes 보장: 쓰기 후 Master 읽기</h3>\n<p>가장 단순한 방법입니다. <strong>쓰기 직후에는 Master에서 읽습니다.</strong></p>\n<!-- [다이어그램 4: 쓰기 후 Master 읽기 전략]\n1. Client -> Master: 데이터 쓰기\n2. Master -> Client: 완료\n3. Client -> Master: 같은 데이터 읽기 (Slave 대신 Master로)\n4. Master -> Client: 최신 데이터 반환\n\n일정 시간(예: 3초) 이후에는 다시 Slave에서 읽기\n-->\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MasterSlaveRoutingDataSource</span> dataSource<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">StringRedisTemplate</span> redisTemplate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">WRITE_TIME_PREFIX</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"write:product:\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> <span class=\"token constant\">MASTER_READ_DURATION_MS</span> <span class=\"token operator\">=</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updatePrice</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">BigDecimal</span> newPrice<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Master에 가격 수정</span>\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">updatePrice</span><span class=\"token punctuation\">(</span>productId<span class=\"token punctuation\">,</span> newPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Redis에 최근 쓰기 기록 (모든 인스턴스가 공유)</span>\n        <span class=\"token class-name\">String</span> key <span class=\"token operator\">=</span> <span class=\"token constant\">WRITE_TIME_PREFIX</span> <span class=\"token operator\">+</span> productId<span class=\"token punctuation\">;</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n            key<span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofMillis</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MASTER_READ_DURATION_MS</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Product</span> <span class=\"token function\">getProduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 최근에 수정된 상품이면 Master에서 읽기</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">shouldReadFromMaster</span><span class=\"token punctuation\">(</span>productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setRoutingKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RoutingKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MASTER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldReadFromMaster</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> key <span class=\"token operator\">=</span> <span class=\"token constant\">WRITE_TIME_PREFIX</span> <span class=\"token operator\">+</span> productId<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">hasKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>2. 세션 기반 Slave 고정</h3>\n<p>같은 세션(사용자)은 항상 같은 Slave에서 읽도록 고정합니다. Monotonic Read 문제를 해결합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">사용자 A의 세션 --> 항상 Slave1\n사용자 B의 세션 --> 항상 Slave2\n사용자 C의 세션 --> 항상 Slave3\n\n세션 ID를 해싱하여 특정 Slave에 고정</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SessionBasedSlaveRouter</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DataSource</span><span class=\"token punctuation\">></span></span> slaves<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">getSlaveForSession</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> sessionId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 세션 ID를 해싱하여 항상 같은 Slave 선택</span>\n        <span class=\"token keyword\">int</span> index <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span>sessionId<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> slaves<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> slaves<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>3. GTID 기반 동기화 대기</h3>\n<p>MySQL 5.6+에서 지원하는 GTID(Global Transaction ID)를 활용합니다. 특정 트랜잭션까지 복제가 완료될 때까지 대기합니다.</p>\n<!-- [다이어그램 6: GTID 기반 동기화]\n1. Client -> Master: INSERT (GTID: uuid:100 발급)\n2. Master -> Client: 완료, GTID=uuid:100\n3. Client -> Slave: \"uuid:100까지 복제됐나요?\" (WAIT_FOR_EXECUTED_GTID_SET)\n4. Slave: 복제 완료될 때까지 대기...\n5. Slave -> Client: 준비됨\n6. Client -> Slave: SELECT 실행\n-->\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GtidAwareService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">JdbcTemplate</span> masterJdbc<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">JdbcTemplate</span> slaveJdbc<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">writeAndReadConsistently</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Data</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 1. Master에 쓰기</span>\n        masterJdbc<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"INSERT INTO ...\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 2. 현재 GTID 위치 확인</span>\n        <span class=\"token class-name\">String</span> gtid <span class=\"token operator\">=</span> masterJdbc<span class=\"token punctuation\">.</span><span class=\"token function\">queryForObject</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"SELECT @@GLOBAL.gtid_executed\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 3. Slave가 해당 GTID까지 복제 완료할 때까지 대기</span>\n        slaveJdbc<span class=\"token punctuation\">.</span><span class=\"token function\">queryForObject</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"SELECT WAIT_FOR_EXECUTED_GTID_SET(?, ?)\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n            gtid<span class=\"token punctuation\">,</span>\n            <span class=\"token number\">5</span>  <span class=\"token comment\">// 최대 5초 대기</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 4. 이제 Slave에서 읽어도 일관성 보장</span>\n        <span class=\"token keyword\">return</span> slaveJdbc<span class=\"token punctuation\">.</span><span class=\"token function\">queryForObject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT ...\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>주의사항</strong></p>\n<ul>\n<li>대기 시간이 길어지면 응답 지연 발생</li>\n<li>타임아웃 설정 필수</li>\n<li>모든 쿼리에 적용하면 성능 저하</li>\n</ul>\n<h3>4. Semi-Synchronous Replication</h3>\n<p>MySQL 설정 레벨에서 최소 1개 Slave에 복제가 완료된 후에 커밋을 확정합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- Master 설정</span>\nINSTALL PLUGIN rpl_semi_sync_master <span class=\"token keyword\">SONAME</span> <span class=\"token string\">'semisync_master.so'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SET</span> <span class=\"token keyword\">GLOBAL</span> rpl_semi_sync_master_enabled <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SET</span> <span class=\"token keyword\">GLOBAL</span> rpl_semi_sync_master_timeout <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">-- 1초</span>\n\n<span class=\"token comment\">-- Slave 설정</span>\nINSTALL PLUGIN rpl_semi_sync_slave <span class=\"token keyword\">SONAME</span> <span class=\"token string\">'semisync_slave.so'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SET</span> <span class=\"token keyword\">GLOBAL</span> rpl_semi_sync_slave_enabled <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>semi-sync replication</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7e8165df5b7ea09736c2f1ee9660104e/75609/semi-sync2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.645569620253163%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbklEQVR42m2QzWoTURiG5xJEWk3MzPmbH5PMzDkT26QxLcGWuIhYKSJtRF2I4EK66KaIKCJVhIIrXXsZbrwO197K4zctdOXi4f04nPNyni8qwoisHtGmGXrivLwgKSpUm+nwAuUGQkXs5I6tiY0nsR4ts9I1SVKjdSCq/Cvuzb8zHX/DDmbYIlBW22SFpzvaZe3xKTeOPnB99YlutcP+ZsK7gy5nh+s8GDtuevnIi7ukx3v0Ho6JhtVr7u/9ZDr5gbk9I+3fofRzcslbGwvWD9/Tef6Za0/P6Mn5wZbi45MOX4/W2J+kdJoN9MsZ7mSX+NGEKC8DWb+iKGtyUY+do2eMKFmUqMZpTU9UVVqh0zY9qtU0bbbKQZBZe4xpiEyzJNs5xm4+w5YT3PYp5fKcwfILejCVvZXoTB5msiMpu8K1BIxrBNG2l0Rq6w316hd6fo4Kc8LqN4u3f5md/EHXCynso/NwWfrfsuaqzNiGf3Zyvl8/3XRcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"세미싱크 레플리케이션\"\n        title=\"\"\n        src=\"/static/7e8165df5b7ea09736c2f1ee9660104e/f058b/semi-sync2.png\"\n        srcset=\"/static/7e8165df5b7ea09736c2f1ee9660104e/c26ae/semi-sync2.png 158w,\n/static/7e8165df5b7ea09736c2f1ee9660104e/6bdcf/semi-sync2.png 315w,\n/static/7e8165df5b7ea09736c2f1ee9660104e/f058b/semi-sync2.png 630w,\n/static/7e8165df5b7ea09736c2f1ee9660104e/40601/semi-sync2.png 945w,\n/static/7e8165df5b7ea09736c2f1ee9660104e/75609/semi-sync2.png 994w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[Semi-Sync 흐름]\n1. Client -> Master: INSERT\n2. Master: Binlog 기록\n3. Master -> Slave: Binlog 전송\n4. Slave: 수신 확인 (ACK)\n5. Master &lt;- Slave: ACK\n6. Master -> Client: 커밋 완료\n\n장점: 최소 1개 Slave에는 데이터가 있음을 보장\n단점: 쓰기 지연 증가 (네트워크 RTT만큼)</code></pre></div>\n<h3>5. 쿼리 라우터 활용 (ProxySQL)</h3>\n<p>애플리케이션 코드 수정 없이 프록시 레벨에서 라우팅을 처리합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d9f1ad65b51fbe8af996abbf6dcd7bf6/2e237/proxySql.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 105.69620253164558%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAACOElEQVR42p2V647TMBCF9/0fCv6wwEqsuqBKRah7641s21xsx3F8Pcw4bbUsFKJGOnI87nwez0zcK5x5Ukroug5N02TxO9v+91ydWzDGQCkFa21WXdd5vBjY9z3m8zmm0ykmkwlmsxlCCJcD+YhVVeUohRAoyxLe+8uBMcZ8bCllFr9fnMOjY6tbfPp8jeuPH3LEr9dGA4MDvGElhB4Qe422Nghsoznb+DejgClSVMUguQJ2s4SHG4Xv72vM3pVolglyDaiCIx0DpCKKymG/6LCdaxQ/FPQ+wNQpyzWAE1Swcth8FFA2Hj9XLXaFwbbgXuTiAJpSWEmgVgQUw2/HHbny2G4kOu2oF0MeNalVFotnhSeSKokWRwK7vUP9VMFWGl70CMIgShprDfe4gieZvR2Xw1OVqZKevjJLQNs4SEH564Y1d1gb34fBI3mH1FGE6yV5e9iY0BhKgQ+I56rxB/BwhrDbwdzewt0/oL+7Q6RPLze58fjyKPEihvDS6Mam79dvNsMGBx2dedQ2oGgsfEz/BkatkeiGCXQJRLoMeM4PO3YEMS6iJ/F8Jx2UGWzGDvbexzdAugB8UcAvl/AvL1Rdke0uRLTUPqLzkKSaWsiSM8+30qJqHUpSZ98CCcAg//w8AOmWPgLZeV33uLkXOTreoNEeXxcK31Yqv/Mpfge2bT5yoqom507FYCDvLqko7MjRuJAytG6HqAWtdS7+pbEJGPm/g8GHqg85jEO+Drk66mQj8cYM/AUhu26WGPmpNQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"프록시 sql\"\n        title=\"\"\n        src=\"/static/d9f1ad65b51fbe8af996abbf6dcd7bf6/f058b/proxySql.png\"\n        srcset=\"/static/d9f1ad65b51fbe8af996abbf6dcd7bf6/c26ae/proxySql.png 158w,\n/static/d9f1ad65b51fbe8af996abbf6dcd7bf6/6bdcf/proxySql.png 315w,\n/static/d9f1ad65b51fbe8af996abbf6dcd7bf6/f058b/proxySql.png 630w,\n/static/d9f1ad65b51fbe8af996abbf6dcd7bf6/2e237/proxySql.png 790w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ProxySQL이 쿼리를 분석하여 자동 라우팅</p>\n<ul>\n<li><strong>SELECT -> Slave</strong></li>\n<li><strong>INSERT/UPDATE/DELETE -> Master</strong></li>\n<li>복제 지연 감지 시 <strong>해당 Slave 제외</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- ProxySQL 설정 예시</span>\n\n<span class=\"token comment\">-- 서버 등록</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> mysql_servers<span class=\"token punctuation\">(</span>hostgroup_id<span class=\"token punctuation\">,</span> hostname<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'master.db.local'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3306</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">-- Writer 그룹</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'slave1.db.local'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3306</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">-- Reader 그룹</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'slave2.db.local'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3306</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 쿼리 라우팅 규칙</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> mysql_query_rules<span class=\"token punctuation\">(</span>rule_id<span class=\"token punctuation\">,</span> match_pattern<span class=\"token punctuation\">,</span> destination_hostgroup<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'^SELECT.*FOR UPDATE'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">-- SELECT FOR UPDATE는 Master로</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'^SELECT'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>               <span class=\"token comment\">-- 일반 SELECT는 Slave로</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.*'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                    <span class=\"token comment\">-- 나머지는 Master로</span>\n\n<span class=\"token comment\">-- 복제 지연 임계치 설정 (3초 초과 시 해당 Slave 제외)</span>\n<span class=\"token keyword\">UPDATE</span> mysql_servers <span class=\"token keyword\">SET</span> max_replication_lag <span class=\"token operator\">=</span> <span class=\"token number\">3</span> <span class=\"token keyword\">WHERE</span> hostgroup_id <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ProxySQL이 주기적으로 각 Slave의 <code class=\"language-text\">Seconds_Behind_Master</code>를 체크해서 자동으로 관리합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[동적 Slave 관리]\nT1: Slave2 복제 지연 5초 -> 임계치(3초) 초과 -> 라우팅 제외\nT2: Slave2가 복제 따라잡는 중...\nT3: Slave2 복제 지연 1초 -> 임계치 이하 -> 다시 라우팅에 포함</code></pre></div>\n<p><strong>상태에 따라 동적으로</strong> 포함/제외됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 애플리케이션은 ProxySQL만 바라봄</span>\nspring<span class=\"token operator\">:</span>\n  datasource<span class=\"token operator\">:</span>\n    url<span class=\"token operator\">:</span> jdbc<span class=\"token operator\">:</span>mysql<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>proxysql<span class=\"token punctuation\">.</span>local<span class=\"token operator\">:</span><span class=\"token number\">6033</span><span class=\"token operator\">/</span>mydb\n    username<span class=\"token operator\">:</span> app_user\n    password<span class=\"token operator\">:</span> xxx</code></pre></div>","wordCount":{"words":285},"frontmatter":{"title":"Master-Slave DB 복제 환경에서의 일관성 관리","date":"December 02, 2025","description":"Master-Slave 구조에서 발생하는 복제 지연 문제와 읽기/쓰기 일관성을 보장하는 전략을 알아봅니다."}},"previous":{"fields":{"slug":"/db-cache-consistency/"},"frontmatter":{"title":"DB와 Cache 사이의 일관성 관리 전략"}},"next":{"fields":{"slug":"/tomcat-architecture/"},"frontmatter":{"title":"Tomcat 아키텍처"}}},"pageContext":{"id":"95e30fc0-854e-58ee-8973-9a235ae408e8","previousPostId":"27682fe2-7c54-51f4-ab5c-0d9651209b5f","nextPostId":"cf002e08-7ae1-521d-ae4b-8132fdc3aff2"}},"staticQueryHashes":["3257411868","3517523002"],"slicesMap":{}}