{"componentChunkName":"component---src-templates-blog-post-js","path":"/mysql-histogram/","result":{"data":{"site":{"siteMetadata":{"title":"GoToBill"}},"markdownRemark":{"id":"4c6d09e4-c0ee-565e-998c-5ad61669fc8b","excerpt":"기존 통계 정보의 한계 MySQL 5.7까지의 통계 정보는 치명적인 약점이 있었습니다. 데이터 분포를 전혀 알 수 없다는 점입니다. 평균만 알려주는 통계 100만 건의 주문 테이블에서 사용자별 통계를 보겠습니다. 옵티마이저는 이렇게 계산합니다. 실제 데이터 분포 user_id order…","html":"<h2>기존 통계 정보의 한계</h2>\n<p>MySQL 5.7까지의 통계 정보는 치명적인 약점이 있었습니다. <strong>데이터 분포를 전혀 알 수 없다는 점</strong>입니다.</p>\n<h3>평균만 알려주는 통계</h3>\n<p>100만 건의 주문 테이블에서 사용자별 통계를 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 통계 정보</span>\n전체 레코드: <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">000</span><span class=\"token punctuation\">,</span><span class=\"token number\">000</span>건\n유니크한 user_id: <span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">000</span>개</code></pre></div>\n<p>옵티마이저는 이렇게 계산합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">평균 주문 건수 = 1,000,000 / 10,000 = 100건</code></pre></div>\n<p><strong>실제 데이터 분포</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> user_id<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> order_count\n<span class=\"token keyword\">FROM</span> orders\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> user_id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> order_count <span class=\"token keyword\">DESC</span>\n<span class=\"token keyword\">LIMIT</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></code></pre></div>\n<table>\n<thead>\n<tr>\n<th>user_id</th>\n<th>order_count</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1001</td>\n<td>50000</td>\n</tr>\n<tr>\n<td>1002</td>\n<td>45000</td>\n</tr>\n<tr>\n<td>1003</td>\n<td>30000</td>\n</tr>\n<tr>\n<td>...</td>\n<td>...</td>\n</tr>\n<tr>\n<td>9999</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>실제로는 소수의 VIP 고객이 대부분의 주문을 차지하지만, 옵티마이저는 모든 사용자가 평균 100건씩 주문했다고 가정합니다.</p>\n<h3>잘못된 실행 계획의 결과</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> orders o\n<span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> order_items oi <span class=\"token keyword\">ON</span> o<span class=\"token punctuation\">.</span>order_id <span class=\"token operator\">=</span> oi<span class=\"token punctuation\">.</span>order_id\n<span class=\"token keyword\">WHERE</span> o<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> <span class=\"token number\">1001</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">-- VIP 고객 (50000건)</span></code></pre></div>\n<p><strong>옵티마이저 판단 (히스토그램 없이)</strong></p>\n<ul>\n<li>user_id = 1001은 대략 100건일 것이다</li>\n<li>orders 테이블을 먼저 읽고 order_items와 조인하면 되겠다</li>\n</ul>\n<p><strong>실제 실행</strong></p>\n<ul>\n<li>orders에서 50000건 조회</li>\n<li>order_items와 50000번 조인</li>\n<li>예상보다 500배 많은 데이터 처리</li>\n</ul>\n<p>이런 상황에서 히스토그램이 필요합니다.</p>\n<h2>히스토그램이란?</h2>\n<p>히스토그램은 칼럼값의 <strong>분포도</strong>를 저장하는 통계 정보입니다. MySQL 8.0부터 지원됩니다.</p>\n<p><strong>평균 vs 분포</strong></p>\n<table>\n<thead>\n<tr>\n<th>구분</th>\n<th>기존 통계</th>\n<th>히스토그램</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>제공 정보</td>\n<td>평균</td>\n<td>구간별 분포</td>\n</tr>\n<tr>\n<td>user_id=1001 예측</td>\n<td>100건</td>\n<td>50000건</td>\n</tr>\n<tr>\n<td>user_id=9999 예측</td>\n<td>100건</td>\n<td>1건</td>\n</tr>\n<tr>\n<td>정확도</td>\n<td>낮음</td>\n<td>높음</td>\n</tr>\n</tbody>\n</table>\n<p>히스토그램을 사용하면 옵티마이저가 실제 데이터 분포를 알고 더 정확한 실행 계획을 수립할 수 있습니다.</p>\n<h2>히스토그램 종류</h2>\n<p>MySQL 8.0은 두 가지 히스토그램을 지원합니다.</p>\n<h3>Singleton 히스토그램</h3>\n<p><strong>값별로</strong> 레코드 건수를 관리합니다. 값의 개수가 적을 때 사용됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 성별 칼럼 (값이 2개)</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> employees <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> gender<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span>\n    COLUMN_NAME<span class=\"token punctuation\">,</span>\n    JSON_EXTRACT<span class=\"token punctuation\">(</span>HISTOGRAM<span class=\"token punctuation\">,</span> <span class=\"token string\">'$.histogram-type'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">type</span>\n<span class=\"token keyword\">FROM</span> information_schema<span class=\"token punctuation\">.</span>COLUMN_STATISTICS\n<span class=\"token keyword\">WHERE</span> SCHEMA_NAME <span class=\"token operator\">=</span> <span class=\"token string\">'employees'</span> <span class=\"token operator\">AND</span> TABLE_NAME <span class=\"token operator\">=</span> <span class=\"token string\">'employees'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>히스토그램 데이터 예시</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"buckets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// 'M': 60%</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">]</span>     <span class=\"token comment\">// 'F': 40% (누적 100%)</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"enum\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"histogram-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"singleton\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>해석</strong></p>\n<ul>\n<li>남성('M'): 60%</li>\n<li>여성('F'): 40% (1.0 - 0.6)</li>\n</ul>\n<p>모든 값이 누적 비율로 표시됩니다.</p>\n<h3>Equi-Height 히스토그램</h3>\n<p><strong>범위별로</strong> 레코드 건수를 관리합니다. 값의 개수가 많을 때 사용됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 입사일 칼럼 (값이 수천 개)</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> employees <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> hire_date<span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>히스토그램 데이터 예시</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"buckets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"1985-01-01\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1990-12-31\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1500</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 1980년대: 25%</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"1991-01-01\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1995-12-31\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.50</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1200</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 1990년대 전반: 25%</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"1996-01-01\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2000-12-31\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.75</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1300</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 1990년대 후반: 25%</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"2001-01-01\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2005-12-31\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1400</span><span class=\"token punctuation\">]</span>   <span class=\"token comment\">// 2000년대: 25%</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"histogram-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"equi-height\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>각 버킷은 <strong>비슷한 레코드 건수</strong>를 갖도록 범위가 나뉩니다.</p>\n<p><strong>버킷 구성</strong></p>\n<ul>\n<li>범위 시작값</li>\n<li>범위 종료값</li>\n<li>누적 비율</li>\n<li>유니크 값 개수</li>\n</ul>\n<h2>히스토그램 생성 및 관리</h2>\n<h3>히스토그램 생성</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 단일 칼럼</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 여러 칼럼</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id<span class=\"token punctuation\">,</span> product_id<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 버킷 개수 지정 (기본값 100, 최대 1024)</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id <span class=\"token keyword\">WITH</span> <span class=\"token number\">200</span> BUCKETS<span class=\"token punctuation\">;</span></code></pre></div>\n<h3>히스토그램 확인</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 히스토그램 목록 조회</span>\n<span class=\"token keyword\">SELECT</span>\n    SCHEMA_NAME<span class=\"token punctuation\">,</span>\n    TABLE_NAME<span class=\"token punctuation\">,</span>\n    COLUMN_NAME<span class=\"token punctuation\">,</span>\n    JSON_EXTRACT<span class=\"token punctuation\">(</span>HISTOGRAM<span class=\"token punctuation\">,</span> <span class=\"token string\">'$.histogram-type'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span>\n    JSON_EXTRACT<span class=\"token punctuation\">(</span>HISTOGRAM<span class=\"token punctuation\">,</span> <span class=\"token string\">'$.number-of-buckets-specified'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> buckets\n<span class=\"token keyword\">FROM</span> information_schema<span class=\"token punctuation\">.</span>COLUMN_STATISTICS<span class=\"token punctuation\">;</span></code></pre></div>\n<table>\n<thead>\n<tr>\n<th>SCHEMA_NAME</th>\n<th>TABLE_NAME</th>\n<th>COLUMN_NAME</th>\n<th>type</th>\n<th>buckets</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>mydb</td>\n<td>orders</td>\n<td>user_id</td>\n<td>\"equi-height\"</td>\n<td>100</td>\n</tr>\n<tr>\n<td>mydb</td>\n<td>orders</td>\n<td>amount</td>\n<td>\"equi-height\"</td>\n<td>100</td>\n</tr>\n</tbody>\n</table>\n<h3>히스토그램 삭제</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 히스토그램 삭제 (즉시 완료, 데이터는 건드리지 않음)</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">DROP</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">;</span></code></pre></div>\n<p>히스토그램 삭제는 딕셔너리 정보만 제거하므로 빠르게 완료됩니다. 하지만 삭제 후 실행 계획이 달라질 수 있으니 주의해야 합니다.</p>\n<h2>히스토그램의 성능 개선 효과</h2>\n<h3>조건절 예측 정확도 향상</h3>\n<p>히스토그램이 없을 때와 있을 때의 차이를 비교해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 히스토그램 없이 실행</span>\n<span class=\"token keyword\">EXPLAIN</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">WHERE</span> first_name <span class=\"token operator\">=</span> <span class=\"token string\">'Zita'</span>\n  <span class=\"token operator\">AND</span> birth_date <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'1950-01-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'1960-01-01'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<table>\n<thead>\n<tr>\n<th>rows</th>\n<th>filtered</th>\n<th>예상 건수</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>224</td>\n<td>11.11%</td>\n<td>24.8건</td>\n</tr>\n</tbody>\n</table>\n<p>옵티마이저는 birth_date가 균등 분포라고 가정하여 11.11%를 예측했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 히스토그램 생성</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> employees <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> birth_date<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 다시 실행</span>\n<span class=\"token keyword\">EXPLAIN</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">WHERE</span> first_name <span class=\"token operator\">=</span> <span class=\"token string\">'Zita'</span>\n  <span class=\"token operator\">AND</span> birth_date <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'1950-01-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'1960-01-01'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<table>\n<thead>\n<tr>\n<th>rows</th>\n<th>filtered</th>\n<th>예상 건수</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>224</td>\n<td>60.82%</td>\n<td>136.2건</td>\n</tr>\n</tbody>\n</table>\n<p>히스토그램을 사용하니 실제 데이터 분포를 반영하여 60.82%로 정확히 예측했습니다.</p>\n<p><strong>실제 데이터 확인</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total<span class=\"token punctuation\">,</span>\n    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> birth_date <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'1950-01-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'1960-01-01'</span>\n        <span class=\"token keyword\">THEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ELSE</span> <span class=\"token number\">0</span> <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">matched</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> birth_date <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'1950-01-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'1960-01-01'</span>\n        <span class=\"token keyword\">THEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ELSE</span> <span class=\"token number\">0</span> <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> ratio\n<span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">WHERE</span> first_name <span class=\"token operator\">=</span> <span class=\"token string\">'Zita'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<table>\n<thead>\n<tr>\n<th>total</th>\n<th>matched</th>\n<th>ratio</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>224</td>\n<td>143</td>\n<td>63.84%</td>\n</tr>\n</tbody>\n</table>\n<p>히스토그램 예측(60.82%)이 실제 비율(63.84%)에 매우 근접합니다.</p>\n<h3>조인 순서 최적화</h3>\n<p>히스토그램은 조인 순서 결정에 큰 영향을 미칩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 두 테이블 조인</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> salaries s\n<span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> employees e <span class=\"token keyword\">ON</span> e<span class=\"token punctuation\">.</span>emp_no <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>emp_no\n    <span class=\"token operator\">AND</span> e<span class=\"token punctuation\">.</span>birth_date <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'1950-01-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'1950-02-01'</span>\n<span class=\"token keyword\">WHERE</span> s<span class=\"token punctuation\">.</span>salary <span class=\"token operator\">BETWEEN</span> <span class=\"token number\">40000</span> <span class=\"token operator\">AND</span> <span class=\"token number\">70000</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>조인 순서별 성능 차이</strong></p>\n<table>\n<thead>\n<tr>\n<th>조인 순서</th>\n<th>실행 시간</th>\n<th>드라이빙 테이블 건수</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>employees → salaries</td>\n<td>0.13초</td>\n<td>소수</td>\n</tr>\n<tr>\n<td>salaries → employees</td>\n<td>1.29초</td>\n<td>다수</td>\n</tr>\n</tbody>\n</table>\n<p>거의 10배 차이입니다.</p>\n<p><strong>히스토그램이 없으면</strong></p>\n<ul>\n<li>birth_date와 salary 칼럼의 데이터 분포를 모름</li>\n<li>테이블 크기만 보고 조인 순서 결정</li>\n<li>잘못된 순서 선택 가능성 높음</li>\n</ul>\n<p><strong>히스토그램이 있으면</strong></p>\n<ul>\n<li>각 조건에 일치하는 레코드 수를 정확히 예측</li>\n<li>적은 건수를 반환하는 테이블을 드라이빙으로 선택</li>\n<li>최적의 조인 순서 자동 선택</li>\n</ul>\n<p>InnoDB 버퍼 풀에 데이터가 없는 경우 디스크 I/O까지 발생하면 수십 배 이상 차이가 날 수 있습니다.</p>\n<h2>히스토그램 vs 인덱스</h2>\n<h3>인덱스가 있는 칼럼은 어떻게 되나?</h3>\n<p>결론부터 말하면, <strong>인덱스가 있는 칼럼은 히스토그램을 사용하지 않습니다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- user_id에 인덱스가 있는 경우</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> orders <span class=\"token keyword\">WHERE</span> user_id <span class=\"token operator\">=</span> <span class=\"token number\">1001</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>옵티마이저는 히스토그램 대신 <strong>인덱스 다이브</strong>(Index Dive)를 수행합니다.</p>\n<p><strong>인덱스 다이브</strong></p>\n<ul>\n<li>실제 인덱스 B-Tree를 탐색</li>\n<li>검색 조건의 실제 값에 대해 샘플링 수행</li>\n<li>히스토그램보다 정확함</li>\n</ul>\n<p>인덱스 다이브는 실제 데이터를 직접 확인하므로 히스토그램보다 항상 정확합니다.</p>\n<h3>히스토그램을 만들어야 하는 칼럼</h3>\n<p><strong>인덱스가 없는 칼럼</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 조회는 자주 하지만 인덱스를 만들기엔 애매한 칼럼</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> amount<span class=\"token punctuation\">,</span> <span class=\"token keyword\">status</span><span class=\"token punctuation\">,</span> created_date<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>WHERE 조건에 자주 사용되지만 인덱스는 없는 칼럼</li>\n<li>조인 조건이지만 인덱스를 만들기 어려운 칼럼</li>\n<li>데이터 분포가 균등하지 않은 칼럼</li>\n</ul>\n<p><strong>인덱스가 있어도 도움이 되는 경우</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 복합 조건</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> orders\n<span class=\"token keyword\">WHERE</span> user_id <span class=\"token operator\">=</span> <span class=\"token number\">1001</span>          <span class=\"token comment\">-- 인덱스 있음</span>\n  <span class=\"token operator\">AND</span> amount <span class=\"token operator\">></span> <span class=\"token number\">100000</span>         <span class=\"token comment\">-- 인덱스 없음, 히스토그램 활용</span>\n  <span class=\"token operator\">AND</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">=</span> <span class=\"token string\">'COMPLETED'</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">-- 인덱스 없음, 히스토그램 활용</span></code></pre></div>\n<p>user_id는 인덱스를 사용하고, amount와 status는 히스토그램으로 정확도를 높입니다.</p>\n<h2>활용 가이드</h2>\n<h3>MySQL 8.0.19 미만 버전 주의</h3>\n<p>MySQL 8.0.19 이전 버전은 히스토그램 생성 시 <strong>무조건 풀 테이블 스캔</strong>을 수행합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 8.0.19 미만: 전체 테이블 스캔 (주의!)</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> large_orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id<span class=\"token punctuation\">;</span></code></pre></div>\n<p>대용량 테이블이라면 서비스 시간대를 피해 실행해야 합니다.</p>\n<p><strong>8.0.19 이상 버전</strong></p>\n<p>InnoDB 자체 샘플링 알고리즘을 사용하여 풀 스캔 없이 히스토그램을 생성합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 샘플링 메모리 크기 조정 (기본 20MB)</span>\n<span class=\"token keyword\">SET</span> <span class=\"token keyword\">GLOBAL</span> histogram_generation_max_mem_size <span class=\"token operator\">=</span> <span class=\"token number\">20971520</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>히스토그램 비활성화</h3>\n<p>히스토그램을 삭제하지 않고 사용만 중단하려면:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 전역 설정</span>\n<span class=\"token keyword\">SET</span> <span class=\"token keyword\">GLOBAL</span> optimizer_switch <span class=\"token operator\">=</span> <span class=\"token string\">'condition_fanout_filter=off'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 현재 세션만</span>\n<span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> optimizer_switch <span class=\"token operator\">=</span> <span class=\"token string\">'condition_fanout_filter=off'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 특정 쿼리만</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token comment\">/*+ SET_VAR(optimizer_switch='condition_fanout_filter=off') */</span>\n    <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> orders\n<span class=\"token keyword\">WHERE</span> user_id <span class=\"token operator\">=</span> <span class=\"token number\">1001</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>condition_fanout_filter 옵션은 히스토그램을 포함한 여러 최적화 기능을 제어하므로 신중하게 사용해야 합니다.</p>\n<h3>버킷 개수 설정</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 기본값 100 (대부분 충분함)</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 값의 종류가 매우 많은 경우</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id <span class=\"token keyword\">WITH</span> <span class=\"token number\">200</span> BUCKETS<span class=\"token punctuation\">;</span></code></pre></div>\n<p>일반적으로 100개 버킷이면 충분합니다. 최대 1024개까지 설정 가능하지만, 200개를 넘으면 효과가 크지 않습니다.</p>\n<h3>히스토그램 갱신 시점</h3>\n<p>히스토그램은 자동으로 갱신되지 않습니다. 수동으로 갱신해야 합니다.</p>\n<p><strong>갱신 시점</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 대량 데이터 변경 후</span>\n<span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> orders <span class=\"token keyword\">WHERE</span> created_at <span class=\"token operator\">&lt;</span> <span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 데이터 분포가 크게 바뀐 경우</span>\n<span class=\"token comment\">-- 예: 특정 프로모션으로 특정 상품 주문 급증</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> product_id<span class=\"token punctuation\">;</span></code></pre></div>\n<p>정기적인 갱신보다는 의미 있는 변화가 있을 때 갱신하는 것이 효율적입니다.</p>\n<h2>요약</h2>\n<p><strong>핵심 포인트</strong></p>\n<ol>\n<li>히스토그램은 칼럼의 데이터 분포를 저장하여 옵티마이저의 예측 정확도를 높입니다.</li>\n<li>Singleton 히스토그램은 값이 적을 때, Equi-Height는 값이 많을 때 사용됩니다.</li>\n<li>조인 순서 최적화로 10배 이상 성능 차이가 발생할 수 있습니다.</li>\n<li>인덱스가 있는 칼럼은 인덱스 다이브를 사용하므로 히스토그램이 불필요합니다.</li>\n<li>MySQL 8.0.19 미만 버전은 풀 테이블 스캔이 발생하므로 주의해야 합니다.</li>\n</ol>\n<p><strong>권장 사항</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 인덱스 없는 칼럼 중 WHERE/JOIN 조건에 자주 사용되는 칼럼</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> amount<span class=\"token punctuation\">,</span> <span class=\"token keyword\">status</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 대량 데이터 변경 후 갱신</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">UPDATE</span> HISTOGRAM <span class=\"token keyword\">ON</span> user_id<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 불필요한 히스토그램 제거</span>\n<span class=\"token keyword\">ANALYZE</span> <span class=\"token keyword\">TABLE</span> orders <span class=\"token keyword\">DROP</span> HISTOGRAM <span class=\"token keyword\">ON</span> unused_column<span class=\"token punctuation\">;</span></code></pre></div>\n<p>다음 포스트에서는 MySQL 코스트 모델을 통해 옵티마이저가 실행 계획의 비용을 어떻게 계산하는지 알아보겠습니다.</p>","wordCount":{"words":654},"frontmatter":{"title":"MySQL 히스토그램으로 쿼리 성능 개선하기","date":"October 18, 2025","description":"MySQL 8.0 히스토그램을 활용하여 데이터 분포를 정확히 파악하고 실행 계획을 개선하는 방법을 예제와 함께 설명합니다."}},"previous":{"fields":{"slug":"/mysql-stats-info/"},"frontmatter":{"title":"MySQL 테이블 통계 정보"}},"next":{"fields":{"slug":"/mysql-cost-model/"},"frontmatter":{"title":"MySQL 코스트 모델 이해하기"}}},"pageContext":{"id":"4c6d09e4-c0ee-565e-998c-5ad61669fc8b","previousPostId":"4999f5fd-0945-585d-817d-9fc01cd371fa","nextPostId":"29392d80-1217-5c84-9834-5067e6ef46a2"}},"staticQueryHashes":["3257411868","3517523002"],"slicesMap":{}}