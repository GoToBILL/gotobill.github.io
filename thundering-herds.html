<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thundering Herds 문제</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f4f8; }
        .request-box {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-8 flex justify-center">
    <div class="bg-white p-8 rounded-xl shadow-2xl" style="min-width: 1200px;">
        <h1 class="text-3xl font-bold text-center text-slate-800 mb-2">Thundering Herds 문제</h1>
        <p class="text-center text-slate-500 mb-10">인기 키의 캐시 미스로 인한 DB 과부하</p>

        <div class="grid grid-cols-2 gap-10">
            <!-- Without Leases -->
            <div>
                <h2 class="text-xl font-bold text-slate-700 mb-6 text-center border-b-4 border-red-500 pb-2">
                    Leases 없이 (문제)
                </h2>

                <div class="bg-gray-50 p-6 rounded-lg space-y-6">
                    <!-- Cache Miss -->
                    <div>
                        <div class="font-semibold text-slate-700 mb-3">1. 인기 키 무효화 (캐시 미스)</div>
                        <div class="flex justify-center">
                            <div class="p-4 bg-yellow-100 border-2 border-yellow-500 rounded-lg text-center">
                                <div class="font-bold text-yellow-800">Cache</div>
                                <div class="text-sm text-yellow-700 mt-1">key: [삭제됨]</div>
                            </div>
                        </div>
                    </div>

                    <!-- 100 Requests -->
                    <div>
                        <div class="font-semibold text-slate-700 mb-3">2. 동시에 100개 요청 도착</div>
                        <div class="grid grid-cols-10 gap-1">
                            <div class="request-box bg-blue-500 text-white text-xs">1</div>
                            <div class="request-box bg-blue-500 text-white text-xs">2</div>
                            <div class="request-box bg-blue-500 text-white text-xs">3</div>
                            <div class="request-box bg-blue-500 text-white text-xs">4</div>
                            <div class="request-box bg-blue-500 text-white text-xs">5</div>
                            <div class="request-box bg-blue-500 text-white text-xs">6</div>
                            <div class="request-box bg-blue-500 text-white text-xs">7</div>
                            <div class="request-box bg-blue-500 text-white text-xs">8</div>
                            <div class="request-box bg-blue-500 text-white text-xs">9</div>
                            <div class="request-box bg-blue-500 text-white text-xs">10</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">...</div>
                            <div class="request-box bg-blue-400 text-white text-xs">99</div>
                            <div class="request-box bg-blue-400 text-white text-xs">100</div>
                        </div>
                    </div>

                    <!-- All to DB -->
                    <div>
                        <div class="text-center text-2xl mb-2">↓ ↓ ↓</div>
                        <div class="font-semibold text-red-600 mb-3">3. 모든 요청이 DB로!</div>
                        <div class="flex justify-center">
                            <div class="p-6 bg-red-100 border-2 border-red-500 rounded-lg relative">
                                <div class="font-bold text-red-800 text-lg">Database</div>
                                <div class="text-sm text-red-700 mt-2">
                                    SELECT * FROM users WHERE id=123
                                </div>
                                <div class="text-xs text-red-600 mt-1">× 100번 실행</div>
                                <div class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-lg">
                                    100
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Result -->
                    <div class="bg-red-50 border-2 border-red-400 rounded-lg p-4">
                        <div class="font-bold text-red-900 mb-2">결과:</div>
                        <ul class="text-sm text-red-800 space-y-1">
                            <li>• DB 과부하 (17,000 쿼리/초)</li>
                            <li>• 응답 시간 급격히 증가</li>
                            <li>• 캐스케이딩 장애 위험</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- With Leases -->
            <div>
                <h2 class="text-xl font-bold text-slate-700 mb-6 text-center border-b-4 border-green-500 pb-2">
                    Leases 사용 (해결)
                </h2>

                <div class="bg-gray-50 p-6 rounded-lg space-y-6">
                    <!-- Cache Miss -->
                    <div>
                        <div class="font-semibold text-slate-700 mb-3">1. 인기 키 무효화 (캐시 미스)</div>
                        <div class="flex justify-center">
                            <div class="p-4 bg-yellow-100 border-2 border-yellow-500 rounded-lg text-center">
                                <div class="font-bold text-yellow-800">Cache</div>
                                <div class="text-sm text-yellow-700 mt-1">key: [삭제됨]</div>
                            </div>
                        </div>
                    </div>

                    <!-- Token issued -->
                    <div>
                        <div class="font-semibold text-slate-700 mb-3">2. 첫 요청만 token 발급</div>
                        <div class="grid grid-cols-10 gap-1">
                            <div class="request-box bg-green-500 text-white text-xs flex-col">
                                <div>1</div>
                                <div class="text-[0.5rem]">Token</div>
                            </div>
                            <div class="request-box bg-gray-400 text-white text-xs">2</div>
                            <div class="request-box bg-gray-400 text-white text-xs">3</div>
                            <div class="request-box bg-gray-400 text-white text-xs">4</div>
                            <div class="request-box bg-gray-400 text-white text-xs">5</div>
                            <div class="request-box bg-gray-400 text-white text-xs">6</div>
                            <div class="request-box bg-gray-400 text-white text-xs">7</div>
                            <div class="request-box bg-gray-400 text-white text-xs">8</div>
                            <div class="request-box bg-gray-400 text-white text-xs">9</div>
                            <div class="request-box bg-gray-400 text-white text-xs">10</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">...</div>
                            <div class="request-box bg-gray-300 text-white text-xs">99</div>
                            <div class="request-box bg-gray-300 text-white text-xs">100</div>
                        </div>
                        <div class="text-center text-xs text-green-600 mt-2 font-semibold">
                            나머지 99개는 "잠시 대기" 알림 받음 (10초 내 token 미발급)
                        </div>
                    </div>

                    <!-- Only one to DB -->
                    <div>
                        <div class="text-center text-2xl mb-2">↓</div>
                        <div class="font-semibold text-green-600 mb-3">3. 첫 요청만 DB로</div>
                        <div class="flex justify-center">
                            <div class="p-6 bg-green-100 border-2 border-green-500 rounded-lg relative">
                                <div class="font-bold text-green-800 text-lg">Database</div>
                                <div class="text-sm text-green-700 mt-2">
                                    SELECT * FROM users WHERE id=123
                                </div>
                                <div class="text-xs text-green-600 mt-1">× 1번만 실행</div>
                                <div class="absolute -top-3 -right-3 bg-green-600 text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-lg">
                                    1
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Others retry -->
                    <div>
                        <div class="font-semibold text-slate-700 mb-3">4. 나머지 요청 재시도</div>
                        <div class="text-center text-sm text-slate-600 mb-3">
                            첫 요청이 수 밀리초 내 캐시 저장 완료
                        </div>
                        <div class="flex justify-center">
                            <div class="p-4 bg-blue-100 border-2 border-blue-500 rounded-lg text-center">
                                <div class="font-bold text-blue-800">Cache</div>
                                <div class="text-sm text-blue-700 mt-1">key: value ✓</div>
                                <div class="text-xs text-blue-600 mt-1">나머지 99개 캐시 히트</div>
                            </div>
                        </div>
                    </div>

                    <!-- Result -->
                    <div class="bg-green-50 border-2 border-green-500 rounded-lg p-4">
                        <div class="font-bold text-green-900 mb-2">결과:</div>
                        <ul class="text-sm text-green-800 space-y-1">
                            <li>• DB 부하 99% 감소 (1,300 쿼리/초)</li>
                            <li>• 빠른 응답 시간 유지</li>
                            <li>• 시스템 안정성 대폭 향상</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real Statistics -->
        <div class="mt-8 bg-blue-50 border-2 border-blue-300 rounded-lg p-6">
            <h3 class="font-bold text-blue-900 mb-4 text-xl text-center">실제 Facebook 성과</h3>
            <div class="grid grid-cols-2 gap-8">
                <div class="text-center">
                    <div class="text-sm font-semibold text-blue-800 mb-2">Leases 없이</div>
                    <div class="text-4xl font-bold text-red-600 mb-1">17,000</div>
                    <div class="text-sm text-red-700">쿼리/초 (피크 DB 부하)</div>
                </div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-blue-800 mb-2">Leases 사용</div>
                    <div class="text-4xl font-bold text-green-600 mb-1">1,300</div>
                    <div class="text-sm text-green-700">쿼리/초 (92% 감소)</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
